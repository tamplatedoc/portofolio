<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Futuristic Farming</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');
    body {
      background-color: #0d1a26;
      color: #00f0ff;
      font-family: 'Roboto Mono', monospace;
      margin: 0;
      overflow: hidden;
    }
    .hud {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      padding: 10px;
      background: rgba(0,0,0,0.5);
      border: 1px solid #00f0ff;
      box-shadow: 0 0 10px #00f0ff;
      z-index: 10;
    }
    .resource { text-shadow: 0 0 5px #00f0ff; }
    .actions {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10;
    }
    button {
      background: rgba(0,240,255,0.1);
      border: 1px solid #00f0ff;
      color: #00f0ff;
      padding: 10px 15px;
      cursor: pointer;
      text-transform: uppercase;
      font-family: 'Roboto Mono', monospace;
      box-shadow: 0 0 10px #00f0ff;
    }
    button:hover {
      background: rgba(0,240,255,0.3);
      box-shadow: 0 0 20px #00f0ff;
    }
    .message {
      position: absolute;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      color: #00ff00;
      text-shadow: 0 0 5px #00ff00;
      z-index: 10;
    }
    .hidden { display: none; }
    canvas { display:block; }
  </style>
</head>
<body>

  <div class="hud">
    <div class="resource">Beras: <span id="beras-count">0</span></div>
    <div class="resource">Jagung: <span id="jagung-count">0</span></div>
    <div class="resource hidden" id="gandum-display">Gandum: <span id="gandum-count">0</span></div>
    <div class="resource">Level: <span id="level">1</span></div>
  </div>

  <div class="actions">
    <button onclick="buyPlot('jagung')">Beli Jagung (2B)</button>
    <button onclick="buyPlot('beras')">Beli Beras (2J)</button>
    <button onclick="buyPlot('gandum')" id="gandum-button" class="hidden">Beli Gandum (3B,3J)</button>
    <button onclick="upgradeTownHall()">Town Hall (10B,10J)</button>
  </div>

  <div class="message" id="game-message"></div>
  <canvas id="game-canvas"></canvas>

  <script type="module">
    import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/controls/OrbitControls.js';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/GLTFLoader.js';

    // === Data game ===
    let resources = { beras: 0, jagung: 0, gandum: 0 };
    let plots = { beras: 1, jagung: 1, gandum: 0 };
    let level = 1;

    const elements = {
      berasCount: document.getElementById('beras-count'),
      jagungCount: document.getElementById('jagung-count'),
      gandumCount: document.getElementById('gandum-count'),
      gandumDisplay: document.getElementById('gandum-display'),
      gandumButton: document.getElementById('gandum-button'),
      levelDisplay: document.getElementById('level'),
      gameMessage: document.getElementById('game-message'),
    };

    const costs = {
      jagung: { beras: 2 },
      beras: { jagung: 2 },
      gandum: { beras: 3, jagung: 3 }
    };
    const upgradeCost = { level1: { beras: 10, jagung: 10 } };

    // === Three.js ===
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0d1a26);

    const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, 8, 12);

    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('game-canvas'), antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
    dirLight.position.set(5,10,5);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // Ground
    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(30,30),
      new THREE.MeshLambertMaterial({color:0x1a2e3d})
    );
    ground.rotation.x = -Math.PI/2;
    scene.add(ground);

    // Loader
    const loader = new GLTFLoader();
    const loadedModels = {};
    const plotPositions = [];
    let plotCounter = 0;

    for (let i=0;i<5;i++){
      for (let j=0;j<5;j++){
        plotPositions.push(new THREE.Vector3(i*3-6,0,j*3-6));
      }
    }

    function loadModels(){
      const models = [
        {key:'jagung', file:'assets/models/jagung.glb'},
        {key:'beras', file:'assets/models/padi.glb'},
        {key:'townhall', file:'assets/models/townhall.glb'}
      ];
      let loaded = 0;
      models.forEach(m=>{
        loader.load(m.file,(gltf)=>{
          loadedModels[m.key] = gltf.scene;
          loaded++;
          if(loaded===models.length){
            initializeGame();
          }
        },undefined,(e)=>console.error("Gagal load",m.file,e));
      });
    }

    function add3DPlot(type){
      if(plotCounter<plotPositions.length){
        const modelKey = type;
        if(!loadedModels[modelKey]){ console.warn("Model belum ada:",modelKey); return; }
        const model = loadedModels[modelKey].clone();
        model.scale.set(1,1,1);
        model.position.copy(plotPositions[plotCounter]);
        scene.add(model);
        plotCounter++;
      }
    }

    // === Logic Game ===
    function updateUI(){
      elements.berasCount.textContent = resources.beras;
      elements.jagungCount.textContent = resources.jagung;
      elements.gandumCount.textContent = resources.gandum;
      elements.levelDisplay.textContent = level;
    }
    function showMessage(msg){
      elements.gameMessage.textContent = msg;
      setTimeout(()=>{ elements.gameMessage.textContent=''; },2500);
    }
    function harvest(){
      resources.beras += plots.beras;
      resources.jagung += plots.jagung;
      resources.gandum += plots.gandum;
      showMessage("Panen selesai!");
      updateUI();
    }
    window.buyPlot = function(type){
      const cost = costs[type];
      let canBuy = true;
      for(const res in cost){
        if(resources[res]<cost[res]){ canBuy=false; showMessage(res+" tidak cukup!"); break; }
      }
      if(canBuy){
        for(const res in cost){ resources[res]-=cost[res]; }
        plots[type]++;
        add3DPlot(type);
        showMessage("Berhasil beli "+type+"!");
        updateUI();
      }
    }
    window.upgradeTownHall = function(){
      if(level===1){
        if(resources.beras>=upgradeCost.level1.beras && resources.jagung>=upgradeCost.level1.jagung){
          resources.beras-=upgradeCost.level1.beras;
          resources.jagung-=upgradeCost.level1.jagung;
          level=2;
          elements.gandumDisplay.classList.remove('hidden');
          elements.gandumButton.classList.remove('hidden');
          showMessage("Town Hall upgrade! Gandum tersedia.");
          updateUI();
        } else {
          showMessage("Sumber daya tidak cukup!");
        }
      } else {
        showMessage("Level max.");
      }
    }

    function initializeGame(){
      add3DPlot('jagung');
      add3DPlot('beras');
      setInterval(harvest,10000); // panen tiap 10 detik (biar cepat test)
      updateUI();
      animate();
    }
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene,camera);
    }
    window.addEventListener('resize',()=>{
      camera.aspect=window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth,window.innerHeight);
    });

    loadModels();
  </script>
</body>
</html>
